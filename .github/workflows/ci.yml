name: CI

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.6'

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Cache Go tools
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/go/bin
          key: go-tools-lint-${{ runner.os }}-golangci-lint-2.8.0
      - name: Format
        run: |
          make fmt
          git diff --exit-code
      - name: Vet
        run: make vet
      - name: Lint
        run: make lint

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Cache Go tools
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/go/bin
          key: go-tools-test-${{ runner.os }}-controller-gen-v0.19.0-yamlfmt-0.9.0-kubebuilder-datadog-ci
      - name: Install tools
        run: make -j4 install-controller-gen install-yamlfmt install-kubebuilder install-datadog-ci
      - name: Run unit tests
        run: make test
        env:
          DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: report-test.xml
          path: report-test.xml

  docker-build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [injector, manager, handler]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0
      - name: Build ${{ matrix.target }}
        run: make docker-build-${{ matrix.target }} SKIP_GENERATE=true
      - name: Upload tarball
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: docker-${{ matrix.target }}
          path: bin/${{ matrix.target }}/${{ matrix.target }}.tar.gz
          retention-days: 1

  e2e-test:
    runs-on: ubuntu-latest
    needs: docker-build
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Cache Go tools
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/go/bin
          key: go-tools-e2e-${{ runner.os }}-controller-gen-v0.19.0-yamlfmt-0.9.0-helm-v3.19.0-kubebuilder-datadog-ci
      - name: Install tools
        run: make -j6 install-controller-gen install-yamlfmt install-helm install-kubebuilder install-datadog-ci
      - name: Download docker tarballs
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: docker-*
          merge-multiple: false
      - name: Move tarballs into place
        run: |
          for target in injector manager handler; do
            mkdir -p bin/${target}
            mv docker-${target}/${target}.tar.gz bin/${target}/
          done
      - name: Install Minikube
        run: make ci-install-minikube MINIKUBE_CPUS=max MINIKUBE_MEMORY=max
      - name: Install cert-manager
        run: make lima-install-cert-manager KUBECTL="minikube kubectl --"
      - name: Load images into Minikube
        run: make minikube-load-all
      - name: Run e2e tests
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3.0.2
        with:
          timeout_minutes: 30
          max_attempts: 3
          command: make e2e-test KUBECTL="minikube kubectl --" E2E_TEST_CLUSTER_NAME="minikube" E2E_TEST_KUBECTL_CONTEXT="minikube"
        env:
          DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}
      - name: Save controller logs
        if: failure()
        run: |
          mkdir -p /tmp/logs
          minikube kubectl -- -n chaos-engineering logs -lapp=chaos-controller -c manager --tail=-1 > /tmp/logs/e2e.txt 2>&1 || true
      - name: Upload controller logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: e2e-controller-logs
          path: /tmp/logs
      - name: Upload e2e test report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: report-e2e-test.xml
          path: report-e2e-test.xml

  validate-codegen:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'
      - name: Cache Go tools
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/go/bin
          key: go-tools-codegen-${{ runner.os }}-controller-gen-v0.19.0-yamlfmt-0.9.0-mockery-2.53.5-protoc-3.17.3
      - name: Install tools
        run: make -j6 install-controller-gen install-yamlfmt install-mockery install-protobuf PROTOC_OS=linux
      - name: Validate go dependencies
        run: |
          make godeps
          git diff --exit-code
      - name: Validate manifests
        run: |
          make manifests
          git diff --exit-code
      - name: Validate mocks
        run: |
          make generate-mocks
          git diff --exit-code
      - name: Validate disruptionlistener protobuf
        run: |
          make generate-disruptionlistener-protobuf
          git diff --exit-code ':!go.*'
      - name: Validate chaosdogfood protobuf
        run: |
          make generate-chaosdogfood-protobuf
          git diff --exit-code ':!go.*'

  python-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'
      - name: Install Python dependencies
        run: pip install -r tasks/requirements.txt
      - name: Check third-party licenses
        run: |
          inv license-check
          git diff --exit-code
      - name: Check license headers
        run: |
          inv header-check
          git diff --exit-code

  doc-spellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
      - name: Install markdown-spellcheck
        run: npm install -g markdown-spellcheck
      - name: Spellcheck
        run: mdspell --report --en-us --ignore-numbers --ignore-acronyms $(find . -name vendor -prune -o -name '*.md' -print) || echo "please run 'make spellcheck' for local testing"
