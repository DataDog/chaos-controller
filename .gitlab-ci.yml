# Unless explicitly stated otherwise all files in this repository are licensed
# under the Apache License Version 2.0.
# This product includes software developed at Datadog (https://www.datadoghq.com/).
# Copyright 2020 Datadog, Inc.

---
variables:
  CURRENT_CI_IMAGE: 0.2.0
  CONTROLLER_IMAGE_NAME: chaos-controller
  INJECTOR_IMAGE_NAME: chaos-injector

stages:
  - ci-image
  - build
  - release-internal
  - release-external

# CI image
.docker-runner: &docker-runner
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:18.03.1
  tags:
    - "runner:docker"
    - "size:large"

ci-image:
  <<: *docker-runner
  stage: ci-image
  when: manual
  except: [tags, schedules]
  script:
    - docker build --tag 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/chaos-controller:$CURRENT_CI_IMAGE ci
    - docker push 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/chaos-controller:$CURRENT_CI_IMAGE

# main
.common: &common
  tags:
    - "runner:main"
    - "size:large"
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/chaos-controller:$CURRENT_CI_IMAGE

build:make:
  <<: *common
  stage: build
  when: always
  script:
    - make

# release
.release: &release
  <<: *common
  tags:
    - "runner:docker"
    - "size:large"
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker-push:v2223910-e97a88c-1.0.0
  stage: release-internal
  script:
    - release.sh -t=$TARGET -e=$ENVIRONMENT $IMAGE_NAME $IMAGE_TAG

release-manager-ref:
  <<: *release
  when: manual
  except:
    - tags
  variables:
    IMAGE_NAME: "${CONTROLLER_IMAGE_NAME}"
    IMAGE_TAG: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    TARGET: "manager"
    ENVIRONMENT: "staging"

.release-manager-tag:
  <<: *release
  when: always
  only:
    - tags
  variables:
    IMAGE_NAME: "${CONTROLLER_IMAGE_NAME}"
    IMAGE_TAG: "${CI_COMMIT_TAG}"
    TARGET: "manager"

release-manager-tag-staging:
  extends: .release-manager-tag
  variables:
    ENVIRONMENT: "staging"

release-manager-tag-prod:
  extends: .release-manager-tag
  variables:
    ENVIRONMENT: "prod"

release-injector-ref:
  <<: *release
  when: manual
  except:
    - tags
  variables:
    IMAGE_NAME: "${INJECTOR_IMAGE_NAME}"
    IMAGE_TAG: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    TARGET: "injector"
    ENVIRONMENT: "staging"

.release-injector-tag:
  <<: *release
  when: always
  only:
    - tags
  variables:
    IMAGE_NAME: "${INJECTOR_IMAGE_NAME}"
    IMAGE_TAG: "${CI_COMMIT_TAG}"
    TARGET: "injector"

release-injector-tag-staging:
  extends: .release-injector-tag
  variables:
    ENVIRONMENT: "staging"

release-injector-tag-prod:
  extends: .release-injector-tag
  variables:
    ENVIRONMENT: "prod"

.release-docker-hub: &release-docker-hub
  stage: release-external
  tags: [ "runner:docker", "size:large" ]
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker-notary:v1912023-8c8dc1c-0.6.1
  before_script:
    - echo "Logging into the Docker Hub"
    - DOCKER_REGISTRY_LOGIN=$(aws ssm get-parameter --region us-east-1 --name ci.chaos-engineering.docker_hub_login --with-decryption --query "Parameter.Value" --out text)
    - aws ssm get-parameter --region us-east-1 --name ci.chaos-engineering.docker_hub_pwd --with-decryption --query "Parameter.Value" --out text | docker login --username "$DOCKER_REGISTRY_LOGIN" --password-stdin docker.io
  script:
    - docker pull 727006795293.dkr.ecr.us-east-1.amazonaws.com/${CONTROLLER_IMAGE_NAME}:${TAG}
    - docker tag 727006795293.dkr.ecr.us-east-1.amazonaws.com/${CONTROLLER_IMAGE_NAME}:${TAG} datadog/${CONTROLLER_IMAGE_NAME}:${TAG}
    - docker push datadog/${CONTROLLER_IMAGE_NAME}:${TAG}
    - docker pull 727006795293.dkr.ecr.us-east-1.amazonaws.com/${INJECTOR_IMAGE_NAME}:${TAG}
    - docker tag 727006795293.dkr.ecr.us-east-1.amazonaws.com/${INJECTOR_IMAGE_NAME}:${TAG} datadog/${INJECTOR_IMAGE_NAME}:${TAG}
    - docker push datadog/${INJECTOR_IMAGE_NAME}:${TAG}

release-docker-hub-ref:
  <<: *release-docker-hub
  when: manual
  except:
    - tags
  variables:
    TAG: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"

release-docker-hub-tag:
  <<: *release-docker-hub
  when: always
  only:
    - tags
  variables:
    TAG: "${CI_COMMIT_TAG}"
