# Contributing

This document explains how to install and run the project on a local minikube cluster.

## Signing commits using `gpg`

* Download gpg [here](https://gnupg.org/download/)
* [Generating a new `gpg` key](https://docs.github.com/en/github/authenticating-to-github/managing-commit-signature-verification/generating-a-new-gpg-key)
* [Add `gpg` key to your GitHub account](https://docs.github.com/en/github/authenticating-to-github/managing-commit-signature-verification/adding-a-new-gpg-key-to-your-github-account)
* [Tell git about your signing key](https://docs.github.com/en/github/authenticating-to-github/managing-commit-signature-verification/telling-git-about-your-signing-key)
* [Automatically sign all commits](https://docs.github.com/en/github/authenticating-to-github/managing-commit-signature-verification/signing-commits)

## Requirements

To get started, we need to have the following software installed:

* [docker](https://docs.docker.com/get-docker/)
* [minikube](https://kubernetes.io/docs/tasks/tools/install-minikube/) (1: Installation)
* [golangci-lint](https://github.com/golangci/golangci-lint)
* [Kubebuilder Prerequisites](https://book.kubebuilder.io/quick-start.html#prerequisites) (go, docker, kubectl, kubebuilder, controller-gen)
* [helm](https://helm.sh/docs/intro/quickstart/)

# Developing Locally

## Quick start with Minikube

Once you have installed the above requirements, run the following commands:

* start minikube with containerd engine
  * `make minikube-start`
* deploy cert-manager
  * `kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.3.0/cert-manager.yaml`
* build the new image of the controller with your local files
  * `make minikube-build`
* deploy the CRD and the controller on the minikube cluster
  * `make install`

## Deploying Local Changes to Minikube

To deploy a new version of your local controller code when a version is already deployed, run:
* `make minikube-build`
* `make install`
* `make restart`

To deploy a new version of the CRD by modifying your local `api/v1beta1/disruption_types.go` (or a particular Subspec by modifying `api/v1beta1/disruption_types.go`), run:
* `make install`
* `make restart`

## Testing Local Changes in Minikube

The [samples](examples/) contains sample data which can be used to test your changes.

[demo.yaml](examples/demo.yaml) contains testing resources you can apply directly to your cluster in whatever namespace you choose (it can be `chaos-engineering`) by running:
  * `kubectl create ns chaos-engineering`
  * `kubectl -n chaos-engineering apply -f examples/demo.yaml`

Once you define your test manifest, run:
  * `kubectl -n chaos-engineering apply -f examples/<manifest>.yaml`

To remove the disruption, run:
  * `kubectl -n chaos-engineering delete -f examples/<manifest>.yaml`

See [development guide](docs/development.md) for more robust documentation and tips!

## Available commands

### Running, installing & generating

* `make generate`: generate boilerplate code.
* `make install`: install CRDs and controller into a cluster
* `make manifests`: generate manifests e.g. CRD, RBAC etc.
* `make uninstall`: uninstall CRDs and controller from a cluster
* `make restart`: restart the controller

### Building

* `make minikube-build`: build both images and load them into minikube
  * `make minikube-build-injector`: build the injector image and load it into minikube
  * `make minikube-build-manager`: build the manager image and load it into minikube
* `make injector`: build injector binary
* `make manager`: build manager binary
* `make minikube-start`: start minikube with our ISO and containerd runtime

### Testing, checking & linting

* `make fmt`: run go fmt against the codebase.
* `make header-check`: check all files if they contain the correct header.
* `make license-check`: check if all third party modules contain a license and build the license database.
* `make lint`: run golangci-lint against codebase.
* `make test`: run tests
* `make vet`: run go vet against the codebase.

<p align="center"><kbd>
    <img src="docs/img/deployment/make_minikube.png" width=500 align="center" />
</kbd></p>

<p align="center"><kbd>
    <img src="docs/img/deployment/make_install.png" width=700 align="center" />
</kbd></p>

## Minikube ISO

See [minikube_image.md](docs/minikube_image.md)

## 3rd-party licenses

3rd-party references and licenses are kept in the [LICENSE-3rdparty.csv](LICENSE-3rdparty.csv) file. This file has been generated by the [tasks/3rdparty.py](tasks/3rdparty.py) script. If any vendor is updated, added or removed, this file must be updated as well.