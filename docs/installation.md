# Chaos Controller Advanced Installation Guide

If you do not plan to use the generated manifests because you need some specific configurations, please read this documentation.

## Customize the controller

The controller has multiple flags which can be passed through the [deployment](../chart/templates/deployment.yaml) manifest.

### Delete-only mode

This flag can be enabled specifically on the controller configuration itself (through the arguments of its container). Once enabled, the controller in question will reject any incoming requests to create new injections for new disruptions. In this state, the controller will only accept requests to clean/remove disruptions. The controller must be restarted with the corresponding `--delete-only` argument in order to reach this state.

### Injector pods extra annotations

The injector pods spec is generated by the controller itself. You can add custom annotations to it by providing the `--injector-annotations` flag to the controller. For instance:

```
--injector-annotations "my-annotation.my-workspace.io/foo=bar" --injector-annotations "my-annotation.my-workspace.io/bar=baz"
```

### Injector pods service account

The service account used by the injector (which has different RBAC permission than the controller) can be configured via this flag.
Service accounts are namespaced, so you need to pass this in via flag as well. All chaos pods will be created in this namespace. It is recommended,
 to use the same namespace as the chaos-controller.

```
--injector-service-account <service account name> --injector-service-account-namespace <service account namespace>
```

### Injector image

The injector image to use can be specified via this flag and can be useful in case you keep images in your own registry.

```
--injector-image <image>
```

### Image Pull Secrets

To [pull the Docker images from a private registry](https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry) which is behind authentication you can create a Kubernetes Secret and set the flag below:
```
--image-pull-secrets <secrets-name>
```

### Admission webhook

The admission webhook can be configured, which is mostly only useful if you do not want to rely on cert-manager to generate your certificates. Please note that the admission webhook will **always** expect `tls.crt` and `tls.key` files to exist in the cert dir to work properly.

```
--admission-webhook-cert-dir <cert dir>
--admission-webhook-host <ip to listen on>
--admission-webhook-port <port to listen on>
```

If you use Helm you can set the `controller.webhook.generateCert` parameter to `true` in the [values.yaml](../chart/values.yaml). Running the following from the `chart` directory will generate self-signed certificates and install the controller and any resources needed:

```
helm install -f values.yaml chaos-controller ./
```

### Setup in a cluster with Istio Service Mesh

If you use a service mesh like Istio and the Istio sidecar is installed in application pods by default you may get the following error message:
```
Internal error occurred: failed calling webhook "chaos-controller-webhook-service.chaos-engineering.svc": Post "https://chaos-controller-webhook-service.chaos-engineering.svc:443/validate-chaos-datadoghq-com-v1beta1-disruption?timeout=30s": x509: certificate is not valid for any names, but wanted to match chaos-controller-webhook-service.chaos-engineering.svc
```

You can try disabling the Istio injection on the chaos controller pods. This can be done by adding the following annotation to the Deployment:
```
sidecar.istio.io/inject: "false"
```
